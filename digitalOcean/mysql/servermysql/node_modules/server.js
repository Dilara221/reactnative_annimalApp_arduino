var aedes = require('aedes');
var redis = require('redis');
var persistence = require('aedes-persistence-redis');
var http = require('http'); 
var WebSocket = require('ws');

var ascoltatore = {
  type: 'redis',
  redis: redis,
  db: 12,
  port: 6379,
  return_buffers: true, // to handle binary payloads
  host: 'localhost' // Redis'in adresi
};

var server = aedes({
  persistence: persistence(ascoltatore),
  http: { 
    port: 3000
  }
});

server.on('client', function(client) {
  console.log('client connected', client.id);
});

// fired when a message is received
server.on('publish', function(packet, client) {
  console.log('Published ', packet.topic, packet.payload.toString());
});

// fired when the MQTT server is ready
server.on('ready', function() {
  console.log('Aedes server is up and running');
});

var httpServer = http.createServer(server.handle);
var wss = new WebSocket.Server({ server: httpServer });

wss.on('connection', function connection(ws) {
    console.log('Client connected via WebSocket');
    
    ws.on('message', function incoming(message) {
      console.log('received: %s', message);
    });
});

httpServer.listen(3000, function() {
  console.log('HTTP and WebSocket server listening on port 3000');
});

// Create the server and listen on port 1883
var mqttServer = require('net').createServer(server.handle);
mqttServer.listen(1883, function() {
  console.log('Aedes MQTT server listening on port 1883');
});
